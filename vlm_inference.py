import base64
from zhipuai import ZhipuAI

img_path = "/home/hanbingpi/projects/test/pictures/entrance.jpeg"


# 初始化 ZhipuAI 客户端
client = ZhipuAI(api_key="b7e88901786f46cca64c3629b37caee9.azmT0tAvhVrOzSNe")  # 填写您的APIKey

prompt = '''
你现在正处于一个室内或室外的复杂场景中，比如商场或超市，我可以帮助你完成以下任务：

1. **寻找特定位置**：你可以告诉我你需要找到的地点或设施（如电梯、洗手间、餐厅、商店等），我会为你提供方向和距离指引。
2. **商品定位**：如果你正在购物，告诉我你需要寻找的商品或区域（如牛奶、蔬菜、饮料等），我会帮助你找到它们的位置。
3. **周围环境解读**：如果你需要了解周围的商店、区域或其他环境信息，你可以问我，“这里有什么商店？”“我身边有什么？”等，我会为你提供详细描述。
4. **复杂问题回答**：你可以向我提问关于当前位置、路径、周围物体的更多信息，例如，“我在哪里？”“电梯在哪？”或者“这个地方有什么障碍物？”我会尽力根据场景内容做出准确回答。

请注意：在回答问题时，我会根据你所在的具体场景、位置以及周围环境进行分析，给出最合适的指引和解答。

### case示例

- **问题**：“电梯在哪里？”
  - “电梯位于你正前方大约10米的地方，左手边。继续走，看到商店后左转，电梯就在那。”

- **问题**：“我想找牛奶。”
  - “牛奶区域在你右手边，距离大约5米，靠近冷藏区。继续前行，你会看到一个冷藏货架，牛奶就在其中。”

- **问题**：“我在哪里？”
  - “你当前位于商场入口处，正对着洗手间。商场的电梯在你的左侧，距离大约10米。”

- **问题**：“附近有什么商店？”
  - “你周围有电子产品区、服装区和书店，所有这些商店都在你右侧，步行大约5米。”

- **问题**：“超市里有蔬菜区吗？”
  - “蔬菜区位于商场的左侧，距离你大约20米，经过食品区后你就能看到。”

- **问题**：“我该怎么走才能找到出口？”
  - “出口在商场的北侧，继续直走，经过服装区后，出口就在你前方10米处。”

- **问题**：“这里有障碍物吗？”
  - “前方有一个展示架，稍微需要绕过它。请小心，距离你大约3米。”

---

回复格式要求：
1. 如果用户有确切的提问，只需回复答案，并给我必要的背景信息。

**注意：**  
这个 prompt 设计可以根据实际情况灵活调整。它的目的是帮助用户在复杂的环境中定位目标，并在他们有问题时提供直接、简洁且有用的答案。
'''
   
def run_inference(text, image_path):
    # 调用智谱VLM的API进行推理
    with open(img_path, 'rb') as img_file:
        img_base = base64.b64encode(img_file.read()).decode('utf-8')
    response = client.chat.completions.create(
        model="glm-4v",
        messages=[
            {
                "role": "user",
                "content": [
                    {"type": "text", "text":prompt+"用户的问题或描述为："+text},
                    {"type": "image_url", "image_url": {"url": img_base}}
                ]
            }
        ]
    )
    result = response.choices[0].message.content
    print("推理结果:", result)
    return result
